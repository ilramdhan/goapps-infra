# ============================================================================
# Combined Ingress - Path-Based Routing with TLS (STAGING)
# ============================================================================
# 
# Akses via HTTPS (path-based):
# - Grafana:    https://staging-goapps.mutugading.com/grafana
# - Prometheus: https://staging-goapps.mutugading.com/prometheus
# - MinIO:      https://staging-goapps.mutugading.com/minio/
# - ArgoCD:     https://staging-goapps.mutugading.com/argocd/
# ============================================================================

---
# Grafana Ingress
# Grafana with serve_from_sub_path=true handles sub-path internally.
# NO rewrite-target needed.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - staging-goapps.mutugading.com
      secretName: goapps-tls
  rules:
    - host: staging-goapps.mutugading.com
      http:
        paths:
          - path: /grafana
            pathType: Prefix
            backend:
              service:
                name: prometheus-grafana
                port:
                  number: 80

---
# Prometheus Ingress
# Prometheus with routePrefix=/prometheus handles sub-path internally.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - staging-goapps.mutugading.com
      secretName: goapps-tls
  rules:
    - host: staging-goapps.mutugading.com
      http:
        paths:
          - path: /prometheus
            pathType: Prefix
            backend:
              service:
                name: prometheus-kube-prometheus-prometheus
                port:
                  number: 9090

---
# MinIO Console Ingress
# MinIO Console needs rewrite to strip /minio prefix
# Reference: https://github.com/minio/docs/blob/main/source/integrations/setup-nginx-proxy-with-minio.rst
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minio-ingress
  namespace: minio
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"  # No limit for large uploads
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"
    # Required for MinIO Console WebSocket
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - staging-goapps.mutugading.com
      secretName: goapps-tls
  rules:
    - host: staging-goapps.mutugading.com
      http:
        paths:
          - path: /minio(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: minio
                port:
                  number: 9001  # Console port

---
# ArgoCD Ingress with TLS Termination
# ArgoCD runs in insecure mode (HTTP on port 8080), ingress handles TLS
# Reference: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-ingress
  namespace: argocd
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"  # ArgoCD is in insecure mode
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"
    # Required for ArgoCD gRPC and WebSocket
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - staging-goapps.mutugading.com
      secretName: goapps-tls
  rules:
    - host: staging-goapps.mutugading.com
      http:
        paths:
          - path: /argocd(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: argocd-server
                port:
                  number: 80  # HTTP port (insecure mode)
